@page
@model furnet.Pages.Admin.PackagesModel
@{
    ViewData["Title"] = "Package Management";
    Layout = "_Layout";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-box-seam"></i> Package Management</h1>
        <div>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="statusFilter" id="all" autocomplete="off" @(Model.Filter == "all" ? "checked" : "")>
                <label class="btn btn-outline-primary" for="all">All (@Model.AllCount)</label>

                <input type="radio" class="btn-check" name="statusFilter" id="pending" autocomplete="off" @(Model.Filter == "pending" ? "checked" : "")>
                <label class="btn btn-outline-warning" for="pending">Pending (@Model.PendingCount)</label>

                <input type="radio" class="btn-check" name="statusFilter" id="approved" autocomplete="off" @(Model.Filter == "approved" ? "checked" : "")>
                <label class="btn btn-outline-success" for="approved">Active (@Model.ApprovedCount)</label>

                <input type="radio" class="btn-check" name="statusFilter" id="rejected" autocomplete="off" @(Model.Filter == "rejected" ? "checked" : "")>
                <label class="btn btn-outline-danger" for="rejected">Inactive (@Model.RejectedCount)</label>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form method="get" class="d-flex">
                <input type="hidden" name="filter" value="@Model.Filter" />
                <input type="text" name="search" class="form-control me-2" placeholder="Search packages..." value="@Model.SearchQuery" />
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
            </form>
        </div>
        <div class="col-md-6 text-end">
            <select class="form-select d-inline-block w-auto" onchange="location.href='?filter=@Model.Filter&search=@Model.SearchQuery&sort=' + this.value">
                <option value="newest" selected="@(Model.SortBy == "newest")">Newest First</option>
                <option value="oldest" selected="@(Model.SortBy == "oldest")">Oldest First</option>
                <option value="name" selected="@(Model.SortBy == "name")">Name A-Z</option>
                <option value="downloads" selected="@(Model.SortBy == "downloads")">Most Downloads</option>
            </select>
        </div>
    </div>

    <!-- Package List -->
    <div class="card">
        <div class="card-body">
            @if (Model.Packages.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Package</th>
                                <th>Author(s)</th>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Downloads</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var package in Model.Packages)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong>@package.Name</strong>
                                            @if (!string.IsNullOrEmpty(package.Description))
                                            {
                                                <br><small class="text-muted">@(package.Description.Length > 50 ? package.Description.Substring(0, 50) + "..." : package.Description)</small>
                                            }
                                        </div>
                                    </td>
                                    <td>@string.Join(", ", package.Authors)</td>
                                    <td>@package.Version</td>
                                    <td>
                                        <span class="badge @(package.IsActive ? "bg-success" : "bg-secondary")">
                                            @(package.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>@package.CreatedAt.ToString("MMM dd, yyyy")</td>
                                    <td>@package.Downloads.ToString("N0")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/Packages/Details/@package.Name" class="btn btn-outline-info" title="View">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button onclick="togglePackageStatus(@package.Id)" class="btn btn-outline-warning" title="@(package.IsActive ? "Disable" : "Enable")">
                                                <i class="bi bi-toggle-@(package.IsActive ? "on" : "off")"></i>
                                            </button>
                                            <button onclick="deletePackage(@package.Id)" class="btn btn-outline-danger" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3">No packages found</h4>
                    <p class="text-muted">No packages match your current filter criteria.</p>
                </div>
            }
        </div>
    </div>
</div>

<script>
// Filter change handlers
document.querySelectorAll('input[name="statusFilter"]').forEach(input => {
    input.addEventListener('change', function() {
        if (this.checked) {
            window.location.href = `?filter=${this.id}&search=@Model.SearchQuery&sort=@Model.SortBy`;
        }
    });
});

// ...existing functions...
function togglePackageStatus(packageId) {
    if (confirm('Are you sure you want to toggle the status of this package?')) {
        fetch(`/api/v1/admin/packages/${packageId}/toggle`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.ok ? location.reload() : alert('Failed to toggle package status'))
        .catch(error => {
            console.error('Error:', error);
            alert('Error toggling package status');
        });
    }
}

function deletePackage(packageId) {
    if (confirm('Are you sure you want to delete this package? This action cannot be undone.')) {
        fetch(`/api/v1/admin/packages/${packageId}`, { 
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.ok ? location.reload() : alert('Failed to delete package'))
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting package');
        });
    }
}
</script>
